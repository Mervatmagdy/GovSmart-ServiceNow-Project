<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller = function (spUtil, $location, $window) {

  var c = this;
  c.isSubmitting = false;
  c.editingMode = !!$location.search().sys_id;

  c.form = {
    sys_id: '',
    service_type: 'renew_the_national_id_card',
    location: 'Egypt',
    profession: '',
    government: '',
    region: '',
    renewal_reason: '',
    old_id_number: '',
    description: '',
    fileName: '',
    fileType: '',
    fileData: ''
  };

  c.regions = [];
  c.hasAttachment = false;

  /* ===================== GOVERNMENT → REGION ===================== */
  c.onGovernmentChange = function (selectedRegion) {
    c.form.region = '';
    c.regions = [];

    if (!c.form.government) return;

    c.server.get({
      action: 'get_regions',
      government: c.form.government
    }).then(function (r) {
      c.regions = r.data.regions || [];
      if (selectedRegion) {
        c.form.region = selectedRegion;
      }
    });
  };

  /* ===================== LOAD (EDIT) ===================== */
  if (c.editingMode) {
    var sysId = $location.search().sys_id;

    c.server.get({
      action: 'load_request',
      sys_id: sysId
    }).then(function (r) {
      if (r.data && r.data.form) {
        c.form = angular.copy(r.data.form);
        if (c.form.government) {
          c.onGovernmentChange(c.form.region);
        }
      }
    });
  }

  /* ===================== VALIDATION HELPERS ===================== */
  c.isOldIdValid = function () {
    return /^\d{14}$/.test(c.form.old_id_number || '');
  };

  c.canSubmit = function () {
    return c.form.profession &&
           c.form.government &&
           c.form.region &&
           c.form.renewal_reason &&
           c.isOldIdValid() &&
           c.hasAttachment &&
           !c.isSubmitting;
  };

  /* ===================== SUBMIT ===================== */
  c.submit = function () {
    if (c.isSubmitting) return;

    // check required fields
    if (!c.canSubmit()) {
      if (!c.hasAttachment) {
        spUtil.addErrorMessage("Please upload the supporting document.");
      } else if (!c.isOldIdValid()) {
        spUtil.addErrorMessage("Old National ID must be exactly 14 digits.");
      } else {
        spUtil.addErrorMessage("Please fill in all required fields.");
      }
      return;
    }

    c.isSubmitting = true;

    var fileInput = $window.document.getElementById('fileInput');
    if (fileInput && fileInput.files.length > 0) {
      var file = fileInput.files[0];
      var reader = new FileReader();

      reader.onload = function (e) {
        c.form.fileName = file.name;
        c.form.fileType = file.type;
        c.form.fileData = e.target.result.split(',')[1];
        c.sendToServer();
      };

      reader.readAsDataURL(file);
    } else {
      // safety fallback, shouldn't happen due to canSubmit
      c.sendToServer();
    }
  };

  /* ===================== SEND ===================== */
  c.sendToServer = function () {
    var action = c.form.sys_id ? 'update_request' : 'insert_request';

    c.server.get({
      action: action,
      payload: c.form
    }).then(function (r) {
      c.isSubmitting = false;

      if (r.data && r.data.success) {
        spUtil.addInfoMessage(
          c.editingMode
            ? "Request updated successfully!"
            : "Request submitted successfully!"
        );
        $location.search({ id: 'gov_user_request' });
      } else if (r.data.error === 'DUPLICATE_SUBMIT') {
        spUtil.addErrorMessage("You already submitted this request recently.");
      } else {
        spUtil.addErrorMessage("Error submitting request.");
      }
    });
  };

};
]]></client_script>
        <controller_as>c</controller_as>
        <css>/* ===== FORM GENERAL ===== */&#13;
.form-group {&#13;
  margin-bottom: 18px;&#13;
}&#13;
&#13;
label {&#13;
  font-weight: 600;&#13;
  color: #2c3e50;&#13;
}&#13;
&#13;
/* ===== INPUTS ===== */&#13;
.form-control {&#13;
  height: 42px;&#13;
  border-radius: 6px;&#13;
  border: 1px solid #ced4da;&#13;
  transition: all .2s ease-in-out;&#13;
}&#13;
&#13;
.form-control:focus {&#13;
  border-color: #0056b3;&#13;
  box-shadow: 0 0 0 2px rgba(0,86,179,.15);&#13;
}&#13;
&#13;
/* ===== READ ONLY ===== */&#13;
input[readonly],&#13;
textarea[readonly] {&#13;
  background-color: #f8f9fa !important;&#13;
  cursor: not-allowed;&#13;
}&#13;
&#13;
/* ===== ANGULAR VALIDATION ===== */&#13;
.ng-invalid.ng-touched,&#13;
.ng-invalid.ng-submitted {&#13;
  border-color: #dc3545 !important;&#13;
}&#13;
&#13;
/* ===== ERROR MESSAGE ===== */&#13;
.error-text {&#13;
  font-size: 12px;&#13;
  color: #dc3545;&#13;
  margin-top: 4px;&#13;
}&#13;
&#13;
/* ===== BUTTON ===== */&#13;
.btn-primary {&#13;
  height: 46px;&#13;
  font-weight: 600;&#13;
  border-radius: 6px;&#13;
  background-color: #0056b3;&#13;
  border: none;&#13;
}&#13;
&#13;
.btn-primary:disabled {&#13;
  background-color: #6c757d;&#13;
  cursor: not-allowed;&#13;
}&#13;
&#13;
/* ===== SPINNER ===== */&#13;
.fa-spinner {&#13;
  margin-right: 6px;&#13;
}&#13;
</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id/>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>renew national id card</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function () {

  data.userDisplayName = gs.getUserDisplayName();
  var userId = gs.getUserID();

  /* ===================== REGIONS ===================== */
  if (input && input.action === 'get_regions') {
    data.regions = [];

    if (input.government === 'cairo') {
      data.regions.push({
        value: 'Civil Registry – Abbasia (Main HQ)',
        label: 'Civil Registry – Abbasia (Main HQ)'
      });
    }

    if (input.government === 'alexandria') {
      data.regions.push(
        { value: 'Civil Registry – Sidi Gaber', label: 'Civil Registry – Sidi Gaber' },
        { value: 'Civil Registry – Ibrahimia', label: 'Civil Registry – Ibrahimia' },
        { value: 'Civil Registry – Mansheya', label: 'Civil Registry – Mansheya' }
      );
    }
    return;
  }

  /* ===================== LOAD REQUEST ===================== */
  if (input && input.action === 'load_request' && input.sys_id) {

    var grLoad = new GlideRecord('x_1850706_govsma_0_government_service_request');
    if (grLoad.get(input.sys_id)) {

      data.form = {
        sys_id: grLoad.getUniqueValue(),
        service_type: grLoad.service_type.toString(),
        location: grLoad.location.toString(),
        profession: grLoad.profession.toString(),
        government: grLoad.government.toString(),
        region: grLoad.region.toString(),
        renewal_reason: grLoad.renewal_reason.toString(),
        old_id_number: grLoad.old_id_number.toString()
      };

      // Task description
      var taskGr = new GlideRecord('x_1850706_govsma_0_empl_task');
      taskGr.addQuery('requester_data', grLoad.getUniqueValue());
      taskGr.query();
      data.form.description = taskGr.next()
        ? taskGr.getValue('description') || ''
        : '';
    }
    return;
  }

  /* ===================== INSERT / UPDATE ===================== */
  if (input && (input.action === 'insert_request' || input.action === 'update_request')) {

    var isUpdate = input.action === 'update_request';
    var gr = new GlideRecord('x_1850706_govsma_0_government_service_request');

    if (isUpdate) {
      if (!gr.get(input.payload.sys_id)) {
        data.success = false;
        return;
      }

      gr.profession = input.payload.profession;
      gr.government = input.payload.government;
      gr.region = input.payload.region;
      gr.renewal_reason = input.payload.renewal_reason;
      gr.old_id_number = input.payload.old_id_number;

    } else {

      // Duplicate protection
      var dup = new GlideRecord('x_1850706_govsma_0_government_service_request');
      dup.addQuery('sys_created_by', gs.getUserName());
      dup.addQuery('service_type', input.payload.service_type);
      dup.addQuery('sys_created_on', '>=', gs.minutesAgo(2));
      dup.query();

      if (dup.hasNext()) {
        data.success = false;
        data.error = 'DUPLICATE_SUBMIT';
        return;
      }

      gr.initialize();

      var userGR = new GlideRecord('sys_user');
      if (userGR.get(userId)) {
        gr.user_name = userGR.first_name + ' ' + userGR.last_name;
        gr.email = userGR.email;
        gr.mobile_phone = userGR.mobile_phone;
        gr.marital_status = userGR.u_marital_status;
        gr.national_id = userGR.u_national_id;
        gr.date_of_birth = userGR.u_date_of_birth;
      }

      gr.service_type = input.payload.service_type;
      gr.location = input.payload.location;
      gr.profession = input.payload.profession;
      gr.government = input.payload.government;
      gr.region = input.payload.region;
      gr.renewal_reason = input.payload.renewal_reason;
      gr.old_id_number = input.payload.old_id_number;
    }

    var recordSysId = isUpdate ? gr.update() : gr.insert();

    /* ===================== ATTACHMENT ===================== */
    if (input.payload.fileData) {
      var attachment = new GlideSysAttachment();
      attachment.writeBase64(
        gr,
        input.payload.fileName,
        input.payload.fileType,
        input.payload.fileData
      );
    }

    /* ===================== RESET TASK (EDIT) ===================== */
    if (isUpdate) {
      var taskReset = new GlideRecord('x_1850706_govsma_0_empl_task');
      taskReset.addQuery('requester_data', gr.getUniqueValue());
      taskReset.query();
      while (taskReset.next()) {
        taskReset.document_status = '';
        taskReset.state = 2; // Work in Progress
        taskReset.update();
      }
    }

    data.success = true;
    data.recordSysId = gr.getUniqueValue();
    return;
  }

})();
]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>mohamed.admin</sys_created_by>
        <sys_created_on>2026-01-05 22:43:17</sys_created_on>
        <sys_id>e15a5d41835abed078c11a30ceaad310</sys_id>
        <sys_mod_count>24</sys_mod_count>
        <sys_name>renew national id card</sys_name>
        <sys_package display_value="GovSmart Review &amp;amp; Visit Management System" source="x_1850706_govsma_0">e0e99de183fdf21078c11a30ceaad3e5</sys_package>
        <sys_policy/>
        <sys_scope display_value="GovSmart Review &amp;amp; Visit Management System">e0e99de183fdf21078c11a30ceaad3e5</sys_scope>
        <sys_update_name>sp_widget_e15a5d41835abed078c11a30ceaad310</sys_update_name>
        <sys_updated_by>mohamed.admin</sys_updated_by>
        <sys_updated_on>2026-01-12 14:17:48</sys_updated_on>
        <template><![CDATA[<form name="idForm" novalidate ng-submit="c.submit()" style="padding-bottom: 80px;">

  <!-- ===================== FORM TITLE ===================== -->
  <div class="text-center" style="margin-bottom: 25px;">
    <h2 style="
          font-weight: 700;
          color: #2c3e50;
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          letter-spacing: 1px;
          text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        ">
      Renew National ID Card Request
    </h2>
  </div>

  <!-- ===================== REVIEW NOTES ===================== -->
  <div class="form-group" ng-if="c.editingMode && c.form.description">
    <label>Employee Review Notes</label>
    <textarea class="form-control alert alert-danger"
              ng-model="c.form.description"
              readonly
              rows="3">
    </textarea>
  </div>

  <!-- ===================== LOCATION ONLY ===================== -->
  <div class="row">
    <div class="col-md-6 form-group">
      <label>Location</label>
      <input type="text"
             class="form-control"
             ng-value="c.form.location"
             readonly>
    </div>
  </div>

  <!-- ===================== PROFESSION ===================== -->
  <div class="form-group">
    <label>Profession <span class="text-danger">*</span></label>
    <input type="text"
           class="form-control"
           name="profession"
           ng-model="c.form.profession"
           ng-required="true"
           ng-disabled="c.isSubmitting">

    <div class="error-text"
         ng-if="idForm.profession.$invalid && idForm.$submitted">
      Profession is required
    </div>
  </div>

  <!-- ===================== GOVERNORATE ===================== -->
  <div class="form-group">
    <label>Governorate <span class="text-danger">*</span></label>
    <select class="form-control"
            name="government"
            ng-model="c.form.government"
            ng-change="c.onGovernmentChange()"
            ng-required="true"
            ng-disabled="c.isSubmitting">
      <option value="">-- Select Governorate --</option>
      <option value="cairo">Cairo</option>
      <option value="alexandria">Alexandria</option>
    </select>

    <div class="error-text"
         ng-if="idForm.government.$invalid && idForm.$submitted">
      Governorate is required
    </div>
  </div>

  <!-- ===================== REGION ===================== -->
  <div class="form-group">
    <label>Region <span class="text-danger">*</span></label>
    <select class="form-control"
            name="region"
            ng-model="c.form.region"
            ng-options="r.value as r.label for r in c.regions"
            ng-required="true"
            ng-disabled="c.editingMode || !c.regions.length || c.isSubmitting">
      <option value="">-- Select Region --</option>
    </select>

    <div class="error-text"
         ng-if="idForm.region.$invalid && idForm.$submitted">
      Region is required
    </div>
  </div>

  <!-- ===================== RENEWAL REASON ===================== -->
  <div class="form-group">
    <label>Renewal Reason <span class="text-danger">*</span></label>
    <select class="form-control"
            name="renewal_reason"
            ng-model="c.form.renewal_reason"
            ng-required="true"
            ng-disabled="c.isSubmitting">
      <option value="">-- Select Reason --</option>
      <option value="expiration">Expiration</option>
      <option value="data_update">Data Update</option>
      <option value="address_change">Address Change</option>
      <option value="profession_change">Profession Change</option>
      <option value="marriage_divorce">Marriage / Divorce</option>
    </select>

    <div class="error-text"
         ng-if="idForm.renewal_reason.$invalid && idForm.$submitted">
      Renewal reason is required
    </div>
  </div>

<!-- ===================== OLD NATIONAL ID ===================== -->
<div class="form-group">
  <label> National ID Number <span class="text-danger">*</span></label>
  <input type="text"
         class="form-control"
         name="old_id"
         ng-model="c.form.old_id_number"
         maxlength="14"
         ng-disabled="c.isSubmitting"
         placeholder="Enter 14-digit National ID"
         ng-keypress="($event.which < 48 || $event.which > 57) && $event.preventDefault()"
         ng-blur="c.oldIdTouched = true">

  <!-- Alert under the box -->
  <div class="error-text"
       ng-if="c.oldIdTouched && (!c.form.old_id_number || c.form.old_id_number.length !== 14)">
    National ID must be exactly 14 digits
  </div>
</div>



  <!-- ===================== ATTACHMENT (MANDATORY) ===================== -->
  <div class="form-group">
    <label>Supporting Document <span class="text-danger">*</span></label>
    <input type="file"
           id="fileInput"
           class="form-control"
           ng-disabled="c.isSubmitting"
           onchange="angular.element(this).scope().c.hasAttachment = this.files.length > 0; angular.element(this).scope().$apply()">

    <div class="error-text"
         ng-if="idForm.$submitted && !c.hasAttachment">
      Supporting document is required
    </div>
  </div>

  <!-- ===================== STICKY SUBMIT BUTTON ===================== -->
  <div class="sticky-submit">
    <button type="submit"
            class="btn"
            ng-disabled="idForm.$invalid || !c.hasAttachment || c.isSubmitting"
            ng-class="{
              'btn-primary': idForm.$valid && c.hasAttachment,
              'btn-lightgrey': !idForm.$valid || !c.hasAttachment
            }">
      <i class="fa fa-spinner fa-spin" ng-if="c.isSubmitting"></i>
      Submit Request
    </button>
  </div>

</form>

<style>
/* ===== LIGHT GREY BUTTON ===== */
.btn-lightgrey {
  background-color: #d6d6d6;
  color: #555;
  border: none;
  cursor: not-allowed;
}

.btn-primary {
  background-color: #0056b3;
  color: white;
  border: none;
}

.btn-primary:disabled {
  background-color: #6c757d;
  cursor: not-allowed;
}

/* ===== STICKY BUTTON CONTAINER ===== */
.sticky-submit {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 999;
}

/* ===== BUTTON STYLE ===== */
.sticky-submit .btn {
  padding: 12px 36px;
  font-size: 15px;
  font-weight: 600;
  border-radius: 25px;
  min-width: 200px;
  transition: all 0.3s ease;
  box-shadow: 0 3px 6px rgba(0,0,0,0.1);
}
</style>
]]></template>
    </sp_widget>
</record_update>
